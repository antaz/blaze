#include "attack.h"
#include "bitboard.h"
#include "type.h"

#include <assert.h>
#include <stdio.h>

/*
static const uint64_t SQUARE[65] = {
        0x1, 0x2, 0x4, 0x8,
        0x10, 0x20, 0x40, 0x80,
        0x100, 0x200, 0x400, 0x800,
        0x1000, 0x2000, 0x4000, 0x8000,
        0x10000, 0x20000, 0x40000, 0x80000,
        0x100000, 0x200000, 0x400000, 0x800000,
        0x1000000, 0x2000000, 0x4000000, 0x8000000,
        0x10000000, 0x20000000, 0x40000000, 0x80000000,
        0x100000000, 0x200000000, 0x400000000, 0x800000000,
        0x1000000000, 0x2000000000, 0x4000000000, 0x8000000000,
        0x10000000000, 0x20000000000, 0x40000000000, 0x80000000000,
        0x100000000000, 0x200000000000, 0x400000000000, 0x800000000000,
        0x1000000000000, 0x2000000000000, 0x4000000000000, 0x8000000000000,
        0x10000000000000, 0x20000000000000, 0x40000000000000, 0x80000000000000,
        0x100000000000000, 0x200000000000000, 0x400000000000000,
0x800000000000000, 0x1000000000000000, 0x2000000000000000, 0x4000000000000000,
0x8000000000000000, 0x0
};

*/

// clang-format off
// File mask
static const uint64_t _FILE[8] = {
    0x0101010101010101, 0x0202020202020202, 0x0404040404040404, 0x0808080808080808,
    0x1010101010101010, 0x2020202020202020, 0x4040404040404040, 0x8080808080808080
};

// Rank mask
static const uint64_t _RANK[8] = {
    0x00000000000000ff, 0x000000000000ff00, 0x0000000000ff0000, 0x00000000ff000000,
    0x000000ff00000000, 0x0000ff0000000000, 0x00ff000000000000, 0xff00000000000000
};

// Diagnonal mask
static const uint64_t _DIAG[15] = {
    0x0000000000000080, 0x0000000000008040, 0x0000000000804020,
    0x0000000080402010, 0x0000008040201008, 0x0000804020100804,
    0x0080402010080402, 0x8040201008040201, 0x4020100804020100,
    0x2010080402010000, 0x1008040201000000, 0x0804020100000000,
    0x0402010000000000, 0x0201000000000000, 0x0100000000000000,
};

// Anti-Diagonal mask
static const uint64_t _ADIAG[15] = {
    0x0000000000000001, 0x0000000000000102, 0x0000000000010204,
    0x0000000001020408, 0x0000000102040810, 0x0000010204081020,
    0x0001020408102040, 0x0102040810204080, 0x0204081020408000,
    0x0408102040800000, 0x0810204080000000, 0x1020408000000000,
    0x2040800000000000, 0x4080000000000000, 0x8000000000000000,
};

// King attacks
static const uint64_t KATK[64] = {
    0x0000000000000302, 0x0000000000000705, 0x0000000000000e0a, 0x0000000000001c14,
    0x0000000000003828, 0x0000000000007050, 0x000000000000e0a0, 0x000000000000c040,
    0x0000000000030203, 0x0000000000070507, 0x00000000000e0a0e, 0x00000000001c141c,
    0x0000000000382838, 0x0000000000705070, 0x0000000000e0a0e0, 0x0000000000c040c0,
    0x0000000003020300, 0x0000000007050700, 0x000000000e0a0e00, 0x000000001c141c00,
    0x0000000038283800, 0x0000000070507000, 0x00000000e0a0e000, 0x00000000c040c000,
    0x0000000302030000, 0x0000000705070000, 0x0000000e0a0e0000, 0x0000001c141c0000,
    0x0000003828380000, 0x0000007050700000, 0x000000e0a0e00000, 0x000000c040c00000,
    0x0000030203000000, 0x0000070507000000, 0x00000e0a0e000000, 0x00001c141c000000,
    0x0000382838000000, 0x0000705070000000, 0x0000e0a0e0000000, 0x0000c040c0000000,
    0x0003020300000000, 0x0007050700000000, 0x000e0a0e00000000, 0x001c141c00000000,
    0x0038283800000000, 0x0070507000000000, 0x00e0a0e000000000, 0x00c040c000000000,
    0x0302030000000000, 0x0705070000000000, 0x0e0a0e0000000000, 0x1c141c0000000000,
    0x3828380000000000, 0x7050700000000000, 0xe0a0e00000000000, 0xc040c00000000000,
    0x0203000000000000, 0x0507000000000000, 0x0a0e000000000000, 0x141c000000000000,
    0x2838000000000000, 0x5070000000000000, 0xa0e0000000000000, 0x40c0000000000000
};

// Knight attacks
static const uint64_t NATK[64] = {
    0x0000000000020400, 0x0000000000050800, 0x00000000000a1100, 0x0000000000142200,
    0x0000000000284400, 0x0000000000508800, 0x0000000000a01000, 0x0000000000402000,
    0x0000000002040004, 0x0000000005080008, 0x000000000a110011, 0x0000000014220022,
    0x0000000028440044, 0x0000000050880088, 0x00000000a0100010, 0x0000000040200020,
    0x0000000204000402, 0x0000000508000805, 0x0000000a1100110a, 0x0000001422002214,
    0x0000002844004428, 0x0000005088008850, 0x000000a0100010a0, 0x0000004020002040,
    0x0000020400040200, 0x0000050800080500, 0x00000a1100110a00, 0x0000142200221400,
    0x0000284400442800, 0x0000508800885000, 0x0000a0100010a000, 0x0000402000204000,
    0x0002040004020000, 0x0005080008050000, 0x000a1100110a0000, 0x0014220022140000,
    0x0028440044280000, 0x0050880088500000, 0x00a0100010a00000, 0x0040200020400000,
    0x0204000402000000, 0x0508000805000000, 0x0a1100110a000000, 0x1422002214000000,
    0x2844004428000000, 0x5088008850000000, 0xa0100010a0000000, 0x4020002040000000,
    0x0400040200000000, 0x0800080500000000, 0x1100110a00000000, 0x2200221400000000,
    0x4400442800000000, 0x8800885000000000, 0x100010a000000000, 0x2000204000000000,
    0x0004020000000000, 0x0008050000000000, 0x00110a0000000000, 0x0022140000000000,
    0x0044280000000000, 0x0088500000000000, 0x0010a00000000000, 0x0020400000000000
};
// clang-format on

// static const uint64_t BMAGIC[64] = {
// 	0x0002020202020200, 0x0002020202020000, 0x0004010202000000,
// 0x0004040080000000, 	0x0001104000000000, 0x0000821040000000,
// 0x0000410410400000, 0x0000104104104000, 	0x0000040404040400,
// 0x0000020202020200, 0x0000040102020000, 0x0000040400800000,
// 	0x0000011040000000, 0x0000008210400000, 0x0000004104104000,
// 0x0000002082082000, 	0x0004000808080800, 0x0002000404040400,
// 0x0001000202020200, 0x0000800802004000, 	0x0000800400A00000,
// 0x0000200100884000, 0x0000400082082000, 0x0000200041041000,
// 	0x0002080010101000, 0x0001040008080800, 0x0000208004010400,
// 0x0000404004010200, 	0x0000840000802000, 0x0000404002011000,
// 0x0000808001041000, 0x0000404000820800, 	0x0001041000202000,
// 0x0000820800101000, 0x0000104400080800, 0x0000020080080080,
// 	0x0000404040040100, 0x0000808100020100, 0x0001010100020800,
// 0x0000808080010400, 	0x0000820820004000, 0x0000410410002000,
// 0x0000082088001000, 0x0000002011000800, 	0x0000080100400400,
// 0x0001010101000200, 0x0002020202000400, 0x0001010101000200,
// 	0x0000410410400000, 0x0000208208200000, 0x0000002084100000,
// 0x0000000020880000, 	0x0000001002020000, 0x0000040408020000,
// 0x0004040404040000, 0x0002020202020000, 	0x0000104104104000,
// 0x0000002082082000, 0x0000000020841000, 0x0000000000208800,
// 	0x0000000010020200, 0x0000000404080200, 0x0000040404040400,
// 0x0002020202020200
// };
//
// static const uint64_t RMAGIC[64] = {
// 	0x0080001020400080, 0x0040001000200040, 0x0080081000200080,
// 0x0080040800100080, 	0x0080020400080080, 0x0080010200040080,
// 0x0080008001000200, 0x0080002040800100, 	0x0000800020400080,
// 0x0000400020005000, 0x0000801000200080, 0x0000800800100080,
// 	0x0000800400080080, 0x0000800200040080, 0x0000800100020080,
// 0x0000800040800100, 	0x0000208000400080, 0x0000404000201000,
// 0x0000808010002000, 0x0000808008001000, 	0x0000808004000800,
// 0x0000808002000400, 0x0000010100020004, 0x0000020000408104,
// 	0x0000208080004000, 0x0000200040005000, 0x0000100080200080,
// 0x0000080080100080, 	0x0000040080080080, 0x0000020080040080,
// 0x0000010080800200, 0x0000800080004100, 	0x0000204000800080,
// 0x0000200040401000, 0x0000100080802000, 0x0000080080801000,
// 	0x0000040080800800, 0x0000020080800400, 0x0000020001010004,
// 0x0000800040800100, 	0x0000204000808000, 0x0000200040008080,
// 0x0000100020008080, 0x0000080010008080, 	0x0000040008008080,
// 0x0000020004008080, 0x0000010002008080, 0x0000004081020004,
// 	0x0000204000800080, 0x0000200040008080, 0x0000100020008080,
// 0x0000080010008080, 	0x0000040008008080, 0x0000020004008080,
// 0x0000800100020080, 0x0000800041000080, 	0x00FFFCDDFCED714A,
// 0x007FFCDDFCED714A, 0x003FFFCDFFD88096, 0x0000040810002101,
// 	0x0001000204080011, 0x0001000204000801, 0x0001000082000401,
// 0x0001FFFAABFAD1A2
// };
//
// static const uint64_t RAMASK[64] = {
// 	0x101010101017e, 0x202020202027c, 0x404040404047a, 0x8080808080876,
// 	0x1010101010106e, 0x2020202020205e, 0x4040404040403e, 0x8080808080807e,
// 	0x1010101017e00, 0x2020202027c00, 0x4040404047a00, 0x8080808087600,
// 	0x10101010106e00, 0x20202020205e00, 0x40404040403e00, 0x80808080807e00,
// 	0x10101017e0100, 0x20202027c0200, 0x40404047a0400, 0x8080808760800,
// 	0x101010106e1000, 0x202020205e2000, 0x404040403e4000, 0x808080807e8000,
// 	0x101017e010100, 0x202027c020200, 0x404047a040400, 0x8080876080800,
// 	0x1010106e101000, 0x2020205e202000, 0x4040403e404000, 0x8080807e808000,
// 	0x1017e01010100, 0x2027c02020200, 0x4047a04040400, 0x8087608080800,
// 	0x10106e10101000, 0x20205e20202000, 0x40403e40404000, 0x80807e80808000,
// 	0x17e0101010100, 0x27c0202020200, 0x47a0404040400, 0x8760808080800,
// 	0x106e1010101000, 0x205e2020202000, 0x403e4040404000, 0x807e8080808000,
// 	0x7e010101010100, 0x7c020202020200, 0x7a040404040400, 0x76080808080800,
// 	0x6e101010101000, 0x5e202020202000, 0x3e404040404000, 0x7e808080808000,
// 	0x7e01010101010100, 0x7c02020202020200, 0x7a04040404040400,
// 0x7608080808080800, 	0x6e10101010101000, 0x5e20202020202000,
// 0x3e40404040404000, 0x7e80808080808000
// };
//
// static const uint8_t RSHIFT[64] = {
//     52, 53, 53, 53, 53, 53, 53, 52, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54,
//     54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54,
//     54, 54,54, 53, 53, 54, 54, 54, 54, 54, 54, 53, 53, 54, 54, 54, 54, 54,
//     54, 53, 52, 53, 53, 53, 53, 53, 53, 52
// };
//
// static const uint64_t BAMASK[64] = {
//       0x40201008040200, 0x402010080400, 0x4020100a00, 0x40221400,
//       0x2442800, 0x204085000, 0x20408102000, 0x2040810204000,
//       0x20100804020000, 0x40201008040000, 0x4020100a0000, 0x4022140000,
//       0x244280000, 0x20408500000, 0x2040810200000, 0x4081020400000,
//       0x10080402000200, 0x20100804000400, 0x4020100a000a00, 0x402214001400,
//       0x24428002800, 0x2040850005000, 0x4081020002000, 0x8102040004000,
//       0x8040200020400, 0x10080400040800, 0x20100a000a1000, 0x40221400142200,
//       0x2442800284400, 0x4085000500800, 0x8102000201000, 0x10204000402000,
//       0x4020002040800, 0x8040004081000, 0x100a000a102000, 0x22140014224000,
//       0x44280028440200, 0x8500050080400, 0x10200020100800, 0x20400040201000,
//       0x2000204081000, 0x4000408102000, 0xa000a10204000, 0x14001422400000,
//       0x28002844020000, 0x50005008040200, 0x20002010080400, 0x40004020100800,
//       0x20408102000, 0x40810204000, 0xa1020400000, 0x142240000000,
//       0x284402000000, 0x500804020000, 0x201008040200, 0x402010080400,
//       0x2040810204000, 0x4081020400000, 0xa102040000000, 0x14224000000000,
//       0x28440200000000, 0x50080402000000, 0x20100804020000, 0x40201008040200
// };
//
// static const uint8_t BSHIFT[64] = {
//     58, 59, 59, 59, 59, 59, 59, 58, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59,
//     57, 57, 57, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 55,
//     55, 57, 59, 59, 59, 59, 57, 57, 57, 57, 59, 59, 59, 59, 59, 59, 59, 59,
//     59, 59, 58, 59, 59, 59, 59, 59, 59, 58
// };

// static uint64_t BATTACK[64][512];
// static uint64_t RATTACK[64][4096];
//
// static uint64_t BETWEEN[64][64];
// static uint64_t LINE[64][64];

// void _init_between()
// {
//         uint64_t sq;
//
//         for (int i = 0; i < 64; ++i)
//                 for (int j = 0; j < 64; ++j) {
//                         sq = (1ULL << i) | (1ULL << j);
//                         if (file(i) == file(j) || rank(i) == rank(j))
//                                 BETWEEN[i][j] = rattack(i, sq) & rattack(j,
//                                 sq);
//                         else if (diag(i) == diag(j) || adiag(i) == adiag(j))
//                                 BETWEEN[i][j] = battack(i, sq) & battack(j,
//                                 sq);
//                 }
// }
//
// void _init_line()
// {
//         for (int i = 0; i < 64; ++i)
//                 for (int j = 0; j < 64; ++j) {
//                         if (file(i) == file(j) || rank(i) == rank(j))
//                                 LINE[i][j] =
//                                     (rattack(i, 0ULL) & rattack(j, 0ULL)) |
//                                     (1ULL << i) | (1ULL << j);
//                         else if (diag(i) == diag(j) || adiag(i) == adiag(j))
//                                 LINE[i][j] =
//                                     (battack(i, 0ULL) & battack(j, 0ULL)) |
//                                     (1ULL << i) | (1ULL << j);
//                 }
// }

// static void init()
// {
//         uint64_t subset = 0ULL;
//         uint64_t index;
//
//         for(int sq = 0; sq < 64; ++sq)
//                 while {
//                         index = subset;
//                         index = index * BMAGIC[sq];
//                         index = index >> BSHIFT[sq];
//
//                         BATTACK[sq][index] =
//                 }
//
// }

uint64_t katk(const int i) { return KATK[i]; }

uint64_t natk(const int i)
{
    assert(i < 64);
    assert(i >= 0);
    return NATK[i];
}

uint64_t batk(const int i, const uint64_t block)
{
    // return BATTACK[i][((block & BAMASK[i]) * BMAGIC[i]) >> BSHIFT[i]];
    return oo2r(i, block, _DIAG[diag(i)]) | oo2r(i, block, _ADIAG[adiag(i)]);
}

uint64_t ratk(const int i, const uint64_t block)
{
    // return RATTACK[i][((block & RAMASK[i]) * RMAGIC[i]) >> RSHIFT[i]];
    return oo2r(i, block, _FILE[file(i)]) | oo2r(i, block, _RANK[rank(i)]);
}

uint64_t qatk(const int i, const uint64_t block)
{
    return batk(i, block) | ratk(i, block);
}

uint64_t between(const int i, const int j)
{
    // return BETWEEN[i][j];
    uint64_t sq = (1ULL << i) | (1ULL << j);

    if (file(i) == file(j) || rank(i) == rank(j))
        return ratk(i, sq) & ratk(j, sq);
    else if (diag(i) == diag(j) || adiag(i) == adiag(j))
        return batk(i, sq) & batk(j, sq);
    else
        return 0ULL;
}

uint64_t line(const int i, const int j)
{
    // return LINE[i][j];
    if (file(i) == file(j) || rank(i) == rank(j))
        return (ratk(i, 0ULL) & ratk(j, 0ULL)) | (1ULL << i) | (1ULL << j);
    else if (diag(i) == diag(j) || adiag(i) == adiag(j))
        return (batk(i, 0ULL) & batk(j, 0ULL)) | (1ULL << i) | (1ULL << j);
    else
        return 0ULL;
}
